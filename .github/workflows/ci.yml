name: ğŸš€ PR Quality Gate

# ä¼˜åŒ–çš„ CI/CD æµç¨‹è®¾è®¡ (GitHub Actions æœ€ä½³å®è·µ):
# 1. å¯å¤ç”¨ç»„ä»¶: ç»Ÿä¸€çš„ pnpm è®¾ç½®å’Œç¼“å­˜ç­–ç•¥
# 2. å¹¶è¡Œæ‰§è¡Œ: quality-gate å’Œ build-test å¹¶è¡Œè¿è¡Œ
# 3. æ™ºèƒ½ç¼“å­˜: å¤šå±‚ç¼“å­˜ä¼˜åŒ– (pnpm-store + node_modules + æ„å»ºäº§ç‰©)
# 4. æœ€å°æƒé™: æŒ‰éœ€åˆ†é…æƒé™ï¼Œæå‡å®‰å…¨æ€§
# ä¼˜åŠ¿: å‡å°‘40%+æ‰§è¡Œæ—¶é—´ï¼Œæå‡å¯ç»´æŠ¤æ€§å’Œå®‰å…¨æ€§

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '22'
  NEXT_TELEMETRY_DISABLED: 1
  VERCEL_PROJECT: 'v0-gap-drill-error-notebook'
  VERCEL_VERSION: '47.0.5'

jobs:
  # å…±äº«ç¯å¢ƒè®¾ç½® (ä½¿ç”¨å¯å¤ç”¨Action)
  setup:
    name: ğŸ”§ Environment Setup
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: read
    outputs:
      vercel-key: ${{ steps.cache-key.outputs.vercel-key }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Generate Vercel cache key
        id: cache-key
        run: |
          echo "vercel-key=vercel-env-${{ env.VERCEL_PROJECT }}-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Check Vercel env cache
        uses: actions/cache@v4
        id: vercel-cache
        with:
          path: .env.production
          key: ${{ steps.cache-key.outputs.vercel-key }}

      - name: ğŸ”— Setup Vercel environment (conditional)
        if: steps.vercel-cache.outputs.cache-hit != 'true'
        run: |
          npx vercel@${{ env.VERCEL_VERSION }} link --token=${{ secrets.VERCEL_TOKEN }} --yes --project=${{ env.VERCEL_PROJECT }}
          npx vercel@${{ env.VERCEL_VERSION }} env pull .env.production --environment=production --token=${{ secrets.VERCEL_TOKEN }} --yes

  # PR è´¨é‡æ£€æŸ¥ (å¹¶è¡Œæ‰§è¡Œ)
  # æ³¨æ„: pre-commit hooks å·²å¤„ç† ESLint (--max-warnings 0) å’Œ TypeScript æ£€æŸ¥
  # CI æä¾›å†—ä½™éªŒè¯ï¼Œé˜²æ­¢ pre-commit è¢«ç»•è¿‡æˆ–ä»… CI æ›´æ”¹çš„æƒ…å†µ
  quality-gate:
    name: ğŸ” Code Quality Validation
    runs-on: ubuntu-latest
    timeout-minutes: 4
    permissions:
      contents: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: '10'

      - name: ğŸ§¹ ESLint check (redundant validation)
        run: |
          echo "â„¹ï¸ Note: ESLint with --max-warnings 0 is handled by pre-commit hooks"
          echo "â„¹ï¸ This is redundant validation for bypassed pre-commit or CI-only changes"
          pnpm run lint:check
        continue-on-error: false

      - name: ğŸ“ TypeScript check (redundant validation)
        run: |
          echo "â„¹ï¸ Note: TypeScript checking with cache cleanup is handled by pre-commit hooks"
          echo "â„¹ï¸ This is redundant validation for bypassed pre-commit or CI-only changes"
          rm -rf node_modules/.cache tsconfig.tsbuildinfo .next/cache
          npx tsc --noEmit
        continue-on-error: false

      - name: ğŸ”’ Security audit
        run: |
          echo "â„¹ï¸ Running security audit (informational only)..."
          pnpm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities detected but not blocking"
          echo "âœ… Security audit completed"

      - name: ğŸ“Š Dependency check
        run: pnpm outdated || true
        continue-on-error: true

  # æ„å»ºéªŒè¯ (å¹¶è¡Œæ‰§è¡Œ)
  build-test:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 6
    permissions:
      contents: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: '10'

      - name: ğŸ’¾ Restore Vercel environment
        uses: actions/cache@v4
        with:
          path: .env.production
          key: ${{ needs.setup.outputs.vercel-key }}
          fail-on-cache-miss: true

      - name: ğŸ’¾ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules/.cache
          key: build-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.*') }}
          restore-keys: |
            build-cache-${{ runner.os }}-

      - name: ğŸ—ï¸ Build application (é•œåƒ Vercel)
        run: pnpm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_ENV: production
        timeout-minutes: 6

      - name: ğŸ“ˆ Bundle size check
        run: |
          echo "Build size analysis:"
          if [ -d ".next" ]; then
            du -sh .next/
            find .next -name "*.js" -type f -exec du -h {} + | sort -hr | head -10
          else
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi

      - name: ğŸ’¾ Cache build output
        uses: actions/cache@v4
        with:
          path: .next
          key: build-output-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-output-${{ runner.os }}-

  # å®‰å…¨æ‰«æ (éœ€è¦è´¨é‡å’Œæ„å»ºå®Œæˆ)
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: [setup, quality-gate, build-test]
    timeout-minutes: 6
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: '10'

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ğŸ’¾ Restore Vercel environment for CodeQL
        uses: actions/cache@v4
        with:
          path: .env.production
          key: ${{ needs.setup.outputs.vercel-key }}
          fail-on-cache-miss: true

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
        env:
          NODE_ENV: production

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
