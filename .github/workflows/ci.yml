name: ğŸ”„ CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '22'
  NEXT_TELEMETRY_DISABLED: 1
  VERCEL_PROJECT: 'v0-gap-drill-error-notebook'
  VERCEL_VERSION: '47.0.5'

jobs:
  # å…±äº«ç¯å¢ƒå’Œä¾èµ–è®¾ç½®
  shared-setup:
    name: ğŸš€ Shared Environment Setup
    runs-on: ubuntu-latest
    timeout-minutes: 4
    permissions:
      contents: read
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      vercel-key: ${{ steps.cache-key.outputs.vercel-key }}
      vercel-env-cache: ${{ steps.vercel-cache.outputs.cache-hit }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”‘ Generate cache keys
        id: cache-key
        run: |
          echo "key=npm-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT
          echo "vercel-key=vercel-env-${{ env.VERCEL_PROJECT }}-${{ github.sha }}" >> $GITHUB_OUTPUT
        
      - name: ğŸ’¾ Restore dependencies cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: npm-
          
      - name: ğŸ“¦ Setup Node.js (conditional)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies (conditional)
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: npm ci --frozen-lockfile --prefer-offline
        env:
          NPM_CONFIG_AUDIT: false
          
      - name: ğŸ’¾ Check Vercel env cache
        uses: actions/cache@v4
        id: vercel-cache
        with:
          path: .env.production
          key: ${{ steps.cache-key.outputs.vercel-key }}
          
      - name: ğŸ”— Setup Vercel environment (conditional)
        if: steps.vercel-cache.outputs.cache-hit != 'true'
        run: |
          npx vercel@${{ env.VERCEL_VERSION }} link --token=${{ secrets.VERCEL_TOKEN }} --yes --project=${{ env.VERCEL_PROJECT }}
          npx vercel@${{ env.VERCEL_VERSION }} env pull .env.production --environment=production --token=${{ secrets.VERCEL_TOKEN }} --yes

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-gate:
    name: ğŸ” Quality Gate
    runs-on: ubuntu-latest
    needs: shared-setup
    timeout-minutes: 6
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ’¾ Restore dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.shared-setup.outputs.cache-key }}
          fail-on-cache-miss: true
        
      - name: ğŸ§¹ Run ESLint
        run: npm run lint
        continue-on-error: false
        
      - name: ğŸ“ TypeScript check
        run: npx tsc --noEmit
        continue-on-error: false
        
      - name: ğŸ”’ Security audit
        run: |
          set -e
          npm audit --audit-level=high || {
            echo "âš ï¸ Security vulnerabilities found, but continuing..."
            npm audit --audit-level=critical
          }
        
      - name: ğŸ“Š Dependency check
        run: npm outdated --depth=0 || true
        continue-on-error: true

  # æ„å»ºéªŒè¯
  build-test:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: shared-setup
    timeout-minutes: 8
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ’¾ Restore dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.shared-setup.outputs.cache-key }}
          fail-on-cache-miss: true
        
      - name: ğŸ’¾ Restore Vercel environment
        uses: actions/cache@v4
        with:
          path: .env.production
          key: ${{ needs.shared-setup.outputs.vercel-key }}
          fail-on-cache-miss: true
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_ENV: production
        timeout-minutes: 6
          
      - name: ğŸ“ˆ Bundle size check
        run: |
          echo "Build size analysis:"
          if [ -d ".next" ]; then
            du -sh .next/
            find .next -name "*.js" -type f -exec du -h {} + | sort -hr | head -10
          else
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          
      - name: ğŸ’¾ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .next
            .next/cache
            node_modules/.cache
          key: build-${{ runner.os }}-${{ hashFiles('package-lock.json', 'next.config.*') }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('package-lock.json', 'next.config.*') }}-
            build-${{ runner.os }}-

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: shared-setup
    timeout-minutes: 8
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ’¾ Restore dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.shared-setup.outputs.cache-key }}
          fail-on-cache-miss: true
        
      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: ğŸ’¾ Restore Vercel environment for CodeQL
        uses: actions/cache@v4
        with:
          path: .env.production
          key: ${{ needs.shared-setup.outputs.vercel-key }}
          fail-on-cache-miss: true
          
      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
        env:
          NODE_ENV: production
          
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # CI å®Œæ•´æ€§éªŒè¯ - ç¡®ä¿æ‰€æœ‰å…³é”®æ£€æŸ¥é€šè¿‡
  ci-validation:
    name: âœ… CI Validation Complete
    runs-on: ubuntu-latest
    needs: [quality-gate, build-test, security-scan]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: ğŸ“Š Check all required jobs status
        run: |
          echo "ğŸ” Quality Gate: ${{ needs.quality-gate.result }}"
          echo "ğŸ—ï¸ Build Verification: ${{ needs.build-test.result }}"
          echo "ğŸ›¡ï¸ Security Scan: ${{ needs.security-scan.result }}"
          
          # æ£€æŸ¥å…³é”® job æ˜¯å¦æˆåŠŸ
          if [[ "${{ needs.quality-gate.result }}" != "success" ]]; then
            echo "âŒ Quality Gate failed"
            exit 1
          fi
          
          if [[ "${{ needs.build-test.result }}" != "success" ]]; then
            echo "âŒ Build Verification failed"
            exit 1
          fi
          
          # Security scan å¯ä»¥è·³è¿‡ä½†ä¼šè­¦å‘Š
          if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "âš ï¸ Security Scan failed - please review"
          fi
          
          echo "âœ… All critical CI checks passed!"
          
      - name: ğŸ‰ CI Success Summary
        if: success()
        run: |
          echo "ğŸš€ CI Pipeline completed successfully!"
          echo "âœ… Code quality verified"
          echo "âœ… Build process validated" 
          echo "âœ… All systems ready for deployment"