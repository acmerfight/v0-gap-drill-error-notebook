name: ğŸ§ª E2E Preview Test

# åŸºäº Vercel éƒ¨ç½²çŠ¶æ€äº‹ä»¶è§¦å‘
on:
  deployment_status:
    types: [success]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      preview_url:
        description: 'Preview URL to test'
        required: true
        type: string

env:
  NODE_VERSION: '22'

jobs:
  # ç®€å•çš„è¿æ¥æ€§æµ‹è¯•
  e2e-connectivity-test:
    name: ğŸ§ª Preview Connectivity Test
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # åªå¤„ç† Vercel Preview éƒ¨ç½²æˆåŠŸäº‹ä»¶
    if: |
      (github.event_name == 'deployment_status' &&
       github.event.deployment.environment == 'Preview' &&
       github.event.deployment_status.state == 'success') ||
      github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      statuses: write
      checks: write

    steps:
      - name: ğŸ¯ Get Preview URL
        id: get-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PREVIEW_URL="${{ github.event.inputs.preview_url }}"
          else
            PREVIEW_URL="${{ github.event.deployment_status.target_url }}"
          fi
          echo "ğŸ¯ Testing Preview URL: $PREVIEW_URL"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Test Preview Connection
        id: test-connection
        env:
          PREVIEW_URL: ${{ steps.get-url.outputs.preview_url }}
        run: |
          echo "ğŸ”— Testing connectivity to: $PREVIEW_URL"

          # æµ‹è¯•è¿æ¥æ€§ï¼ˆå…è®¸ 200, 401, 403ï¼‰
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L "$PREVIEW_URL" || echo "000")
          echo "ğŸ“Š HTTP Status: $HTTP_STATUS"

          # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆå“åº”
          if [[ "$HTTP_STATUS" =~ ^(200|401|403)$ ]]; then
            echo "âœ… Preview URL is accessible (HTTP $HTTP_STATUS)"
            echo "test_result=success" >> $GITHUB_OUTPUT

            # ç®€å•çš„å†…å®¹æ£€æŸ¥
            RESPONSE_SIZE=$(curl -s "$PREVIEW_URL" | wc -c)
            echo "ğŸ“ Response size: $RESPONSE_SIZE bytes"

            if [ "$RESPONSE_SIZE" -gt 100 ]; then
              echo "âœ… Response content looks valid"
            else
              echo "âš ï¸ Response seems too small, but connection successful"
            fi
          else
            echo "âŒ Preview URL not accessible (HTTP $HTTP_STATUS)"
            echo "test_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“Š Create Check Status
        if: github.event_name == 'deployment_status'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_RESULT: ${{ steps.test-connection.outputs.test_result }}
          PREVIEW_URL: ${{ steps.get-url.outputs.preview_url }}
        run: |
          if [ "$TEST_RESULT" = "success" ]; then
            STATE="success"
            DESCRIPTION="Preview deployment is accessible and ready for testing"
          else
            STATE="failure"
            DESCRIPTION="Preview deployment connectivity test failed"
          fi

          # åˆ›å»ºæ£€æŸ¥çŠ¶æ€ï¼ˆç”¨äº branch protectionï¼‰
          gh api "/repos/${{ github.repository }}/statuses/${{ github.event.deployment.sha }}" \
            --field state="$STATE" \
            --field target_url="$PREVIEW_URL" \
            --field description="$DESCRIPTION" \
            --field context="e2e/preview-connectivity"

          echo "ğŸ“ Status created: $STATE - $DESCRIPTION"
