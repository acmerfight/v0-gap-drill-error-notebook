name: ðŸ”’ Weekly Security Scan

# æ·±åº¦å®‰å…¨æ‰«æï¼šæ¯å‘¨å…¨é¢æ£€æŸ¥ï¼Œè¡¥å……PRå¢žé‡æ‰«æ
on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTCï¼‰
    - cron: '0 2 * * 1'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '22'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  comprehensive-security:
    name: ðŸ›¡ï¸ å…¨é¢å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
      actions: read
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci --frozen-lockfile --prefer-offline
        
      # å…¨é‡CodeQLåˆ†æžï¼ˆåŒ…å«æ‰€æœ‰è§„åˆ™ï¼‰
      - name: ðŸ” Full CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality,security-extended
          
      - name: ðŸ—ï¸ Build for analysis
        uses: github/codeql-action/autobuild@v3
        env:
          NODE_ENV: production
          
      - name: ðŸ” Perform Full Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript/weekly-scan"
          
      # ä¾èµ–æ¼æ´žæ‰«æ
      - name: ðŸ” Dependency vulnerability scan
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true
          if [ -s audit-results.json ]; then
            echo "ðŸ“‹ å‘çŽ°ä¾èµ–æ¼æ´žï¼Œè¯·æ£€æŸ¥ audit-results.json"
            npm audit --audit-level=high
          fi
          
      # å¯†é’¥æ‰«æï¼ˆæ·±åº¦ï¼‰
      - name: ðŸ•µï¸ Deep secret scan
        uses: trufflesecurity/trufflehog@v3.86.1
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified --no-update
          
      # ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
      - name: ðŸ“Š Generate security report
        run: |
          echo "## ðŸ›¡ï¸ å‘¨åº¦å®‰å…¨æ‰«ææŠ¥å‘Š" > security-report.md
          echo "**æ‰«ææ—¶é—´:** $(date)" >> security-report.md
          echo "**Git Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          if [ -s audit-results.json ]; then
            echo "### ðŸ“¦ ä¾èµ–æ¼æ´žåˆ†æž" >> security-report.md
            jq -r '.vulnerabilities | keys[] as $k | "\(.[$k] | .title): \(.[$k] | .severity)"' audit-results.json >> security-report.md || echo "ä¾èµ–æ‰«æå®Œæˆ" >> security-report.md
          fi
          
      - name: ðŸ“¤ Upload security artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results-${{ github.run_number }}
          path: |
            security-report.md
            audit-results.json